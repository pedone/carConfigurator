@using KFZ_Konfigurator.Models;
@using KFZ_Konfigurator.ViewModels;
@using KFZ_Konfigurator.Helper;
@model KFZ_Konfigurator.ViewModels.ConfigurationOverviewPageViewModel

@{
    Layout = "~/Views/Shared/_ConfigurationLayout.cshtml";
    ViewBag.Title = LocalizationManager.Localize("ConfigurationOverviewTitle");
    ViewBag.BackgroundImage = "carConfiguration.png";
}

@Html.AntiForgeryToken()
<h2>@LocalizationManager.Localize("ConfigurationOverviewHeader")</h2>

<h4>@LocalizationManager.Localize("ConfigurationOverview_TechnicalData_Header")</h4>
<table class="table">
    <tbody>
        <tr>
            <th scope="row">@LocalizationManager.Localize("TechnicalData_Transmission")</th>
            <td>@(Model.EngineSetting.Gears + LocalizationManager.Localize("TechnicalData_Transmission_LabelSuffix"))</td>
        </tr>
        <tr>
            <th scope="row">@LocalizationManager.Localize("TechnicalData_Acceleration")</th>
            <td>@Model.EngineSetting.Acceleration s</td>
        </tr>
        <tr>
            <th scope="row">@LocalizationManager.Localize("TechnicalData_TopSpeed")</th>
            <td>@Model.EngineSetting.TopSpeed km/h</td>
        </tr>
        <tr>
            <th scope="row">@LocalizationManager.Localize("TechnicalData_Consumption")</th>
            <td>@Model.EngineSetting.Consumption l/100 km</td>
        </tr>
        <tr>
            <th scope="row">@LocalizationManager.Localize("TechnicalData_Performance")</th>
            <td>@Model.EngineSetting.Engine.Performance kW (@Model.EngineSetting.Engine.PerformancePS PS)</td>
        </tr>
        <tr>
            <th scope="row">CO<sub>2</sub>-@LocalizationManager.Localize("TechnicalData_Emissions")</th>
            <td>@Model.EngineSetting.Emission g/km</td>
        </tr>
        <tr>
            <th scope="row">@LocalizationManager.Localize("TechnicalData_EngineSize")</th>
            <td>@Model.EngineSetting.Engine.Size cm<sup>3</sup></td>
        </tr>
        <tr>
            <th scope="row">@LocalizationManager.Localize("TechnicalData_FuelType")</th>
            <td>@(LocalizationManager.LocalizeEnum<FuelKind>(MiscHelper.EngineKindToFuelKind(Model.EngineSetting.Engine.EngineKind).ToString()))</td>
        </tr>
    </tbody>
</table>

<div class="input-group mb-3">
    <div class="input-group-prepend">
        <button class="btn btn-outline-secondary" id="generateLinkButton" type="button" disabled>
            @LocalizationManager.Localize("GenerateConfigurationLink_Label")
        </button>
    </div>
    @if (string.IsNullOrEmpty(Model.ConfigurationLink))
    {
        <input type="text" class="form-control" id="configurationName" placeholder="@LocalizationManager.Localize("ConfigurationName_Placeholder")" />
    }
    <input type="text" class="form-control" readonly="readonly" id="configurationLink" value="@Model.ConfigurationLink" />
    <div class="input-group-append">
        <button class="btn btn-outline-secondary" id="copyLinkButton" type="button">@LocalizationManager.Localize("Copy")</button>
    </div>
</div>

<div>
    <button class="btn btn-primary mb-3" id="placeOrderButton" type="button">@LocalizationManager.Localize("PlaceOrder")</button>
    <div class="alert alert-success alert-dismissible fade show" id="orderSuccessAlert" role="alert" hidden>
        Your order was successfully placed
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    </div>
    <div class="alert alert-danger alert-dismissible fade show" id="orderFailedAlert" role="alert" hidden>
        Your order could not be placed
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    </div>
</div>

@section scripts {
    <script type="text/javascript">
        let accessories = @Html.Raw(Json.Encode(Model.Accessories));
        let engineSetting = @Html.Raw(Json.Encode(Model.EngineSetting));
        let paint = @Html.Raw(Json.Encode(Model.Paint));
        let rims = @Html.Raw(Json.Encode(Model.Rims));
        let viewModel = new ConfigurationViewModel({ selectedAccessories: accessories, selectedEngineSetting: engineSetting, selectedPaint: paint, selectedRims: rims });

        //TODO use second viewmodel instead of jquery

        $(document).ready(function () {
            ko.applyBindings(viewModel);
            let configurationLinkElement = $('#configurationLink');
            let copyLinkButtonElement = $('#copyLinkButton');
            let generateLinkButtonElement = $('#generateLinkButton');
            let configurationNameElement = $('#configurationName');

            if (configurationNameElement) {
                configurationNameElement.on('keyup change', function () {
                    generateLinkButtonElement.attr('disabled', $(this).val().length === 0)
                });
            }

            generateLinkButtonElement.click(function () {
                $.ajax({
                    type: 'POST',
                    url: '/ConfigurationOverview/GenerateConfigurationLink',
                    data: { configurationName: configurationNameElement.val() },
                    dataType: 'text'
                }).done(function (data) {
                    generateLinkButtonElement.attr('disabled', true);
                    configurationNameElement.attr('hidden', true);
                    configurationLinkElement.val(data);
                }).fail(function () {
                    //TODO
                });
            });

            copyLinkButtonElement.click(function () {
                configurationLinkElement.select();
                document.execCommand('copy');
            });

            $('#placeOrderButton').click(function () {
                $.ajax({
                    type: 'POST',
                    url: '/ConfigurationOverview/PlaceOrder',
                    data: { configurationName: configurationNameElement.val() },
                    dataType: 'text'
                }).done(function (data) {
                    generateLinkButtonElement.attr("disabled", true);
                    configurationNameElement.attr('hidden', true);
                    configurationLinkElement.val(data);
                    $('#orderSuccessAlert').attr('hidden', true);
                    $('#orderFailedAlert').attr('hidden', false);
                }).fail(function () {
                    $('#orderSuccessAlert').attr('hidden', false);
                    $('#orderFailedAlert').attr('hidden', true);
                });
            });
        });
    </script>
}