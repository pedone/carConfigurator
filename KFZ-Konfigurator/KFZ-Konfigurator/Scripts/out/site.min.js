"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var ConfigurationOverviewViewModel=function e(t){_classCallCheck(this,e);var i=this;this.configurationDescription=ko.observable(""),this.options=t,this.placeOrder=function(){$.ajax({type:"POST",url:"/ConfigurationOverview/PlaceOrder",data:{__RequestVerificationToken:i.options.antiForgeryToken,description:i.configurationDescription()},contentType:"application/x-www-form-urlencoded",dataType:"text"}).done(function(e){console.debug("order successfully placed"),i.options.placeOrderSuccess&&i.options.placeOrderSuccess(e)}).fail(function(e){console.error("failed to place order: "+e.responseText+" ("+e.statusText+")"),console.debug(JSON.stringify(e)),i.options.placeOrderFailure&&i.options.placeOrderFailure()})}};function _defineProperties(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var ViewModel=function e(t){_classCallCheck(this,e),this.id=t.Id,this.price=t.Price,this.isSelected=ko.observable(t.IsSelected),this.name=t.Name,this.size=t.Size,this.category=t.Category},ConfigurationViewModel=function(){function i(e){var t=this;_classCallCheck(this,i),Object.defineProperties(this,{_engineSettingsById:{value:this._toViewModelDictionary(e.EngineSettings),writable:!1,enumerable:!1},_rimsById:{value:this._toViewModelDictionary(e.Rims),writable:!1,enumerable:!1},_paintById:{value:this._toViewModelDictionary(e.Paints),writable:!1,enumerable:!1},accessoriesById:{value:this._toViewModelDictionary(e.Accessories),writable:!1,enumerable:!0}}),this.selectedPaintId=ko.observable(this._getInitialSelectedId(e.Paints)),this._initialPaintId=this.selectedPaintId(),this.selectedRimsId=ko.observable(this._getInitialSelectedId(e.Rims)),this._initialRimsId=this.selectedRimsId(),this.selectedAccessories=ko.observableArray(_.values(this.accessoriesById)).extend({filterSelected:null}),this._initialAccessoryIds=this.selectedAccessoryIds,this.selectedEngineSettings=ko.computed(function(){var e=_.values(t._engineSettingsById);return _.first(_.filter(e,function(e){return e.isSelected()}))}),this._initialEngineSettings=this.selectedEngineSettings(),this.selectedPaint=ko.computed(function(){return t._paintById[t.selectedPaintId()]}),this.selectedRims=ko.computed(function(){return t._rimsById[t.selectedRimsId()]}),this.extrasPrice=ko.computed(function(){return _.reduce(t.selectedAccessories(),function(e,t){return e+t.price},0)+(t.selectedPaint()&&t.selectedPaint().price)+(t.selectedRims()&&t.selectedRims().price)}),this.basePrice=ko.computed(function(){return t.selectedEngineSettings()&&t.selectedEngineSettings().price||0}),this.fullPrice=ko.computed(function(){return t.basePrice()+t.extrasPrice()})}return _createClass(i,[{key:"_getInitialSelectedId",value:function(e){return e&&0!==e.length?(_.find(e,function(e){return e.IsSelected})||e[0]).Id.toString():-1}},{key:"_toViewModelDictionary",value:function(e){var t={};return _.each(e,function(e){t[e.Id]=new ViewModel(e)}),t}},{key:"countCategory",value:function(e,t){return _.filter(e,function(e){return e.category===t}).length}},{key:"selectEngineSettings",value:function(t){_.each(this._engineSettingsById,function(e){e.isSelected(e.id===t)})}},{key:"selectPaint",value:function(e){this.selectedPaintId(e)}},{key:"selectAccessory",value:function(e){var t=this.accessoriesById[e].isSelected();this.accessoriesById[e].isSelected(!t)}},{key:"saveChanges",value:function(e){var t=this.selectedAccessoryIds,i=this._initialAccessoryIds.length!==t.length||0<_.difference(this._initialAccessoryIds,this.selectedAccessoryIds).length,n=this._initialEngineSettings!=this.selectedEngineSettings(),r=this._initialPaintId!=this.selectedPaintId(),s=this._initialRimsId!=this.selectedRimsId();if(i||n||r||s){var o={__RequestVerificationToken:e};r&&(o.paintId=viewModel.selectedPaintId()),s&&(o.rimId=viewModel.selectedRimsId()),n&&(o.engineSettingsId=viewModel.selectedEngineSettings().id),i&&(o.accessoryIds=t),console.debug("saving configuration changes"),$.ajax({async:!1,type:"POST",url:"/Configuration/UpdateActiveConfiguration",data:o,contentType:"application/x-www-form-urlencoded"}).fail(function(e){console.error("failed to save configuration changes: "+e.responseText+" ("+e.statusText+")"),console.debug(JSON.stringify(e))})}else console.debug("no configuration changes")}},{key:"selectedAccessoryIds",get:function(){return _.map(this.selectedAccessories(),function(e){return e.id})}}]),i}();function saveViewModel(e,t,i,n){var r,s={__RequestVerificationToken:i};if(t&&(s.id=t),n)for(r in n)n.hasOwnProperty(r)&&(s[r]=n[r]);return $.ajax({type:"POST",url:e,data:s,contentType:"application/x-www-form-urlencoded"})}function getAntiForgeryToken(e){return e.find('[name="__RequestVerificationToken"]').val()}function formatCurrency(e){return e.toLocaleString()+" EUR"}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),e}ko.extenders.filterSelected=function(e){var t,i=e(),n=ko.observableArray(_.filter(i,function(e){return e.isSelected()})),r=function(t){return function(e){e?n.push(i[t]):n.remove(i[t])}};for(t=0;t<i.length;t+=1)i[t].isSelected.subscribe(r(t));return n};var ModelSelectionViewModel=function(){function e(){_classCallCheck(this,e),this.curModelFilter=ko.observable("")}return _createClass(e,[{key:"filterModels",value:function(e){e!==this.curModelFilter()&&this.curModelFilter(e)}}]),e}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var OrderItemViewModel=function e(t){_classCallCheck(this,e),this.id=t.Id,this.basePrice=t.BasePrice,this.extrasPrice=t.ExtrasPrice,this.price=t.Price,this.description=t.Description,this.dateTime=t.DateTime,this.model=t.Model,this.guid=t.Guid,this.linkUrl=t.LinkUrl},OrderListViewModel=function e(t,i){var n=this;_classCallCheck(this,e);var o=this;this.orders=ko.observableArray(_.map(t,function(e){return new OrderItemViewModel(e)})),this.pages=ko.observableArray([]),_.times(i,function(e){return n.pages().push(e+1)}),this.currentPageIndex=ko.observable(0),this.deleteItem=function(i,e){var n=_.find(o.orders(),function(e){return e.id==i});if(n){var t,r,s=getAntiForgeryToken(e);(t=i,r=s,$.ajax({type:"POST",url:"/OrderList/delete",data:{__RequestVerificationToken:r,id:t,pageIndex:o.currentPageIndex()},contentType:"application/x-www-form-urlencoded",dataType:"json"})).done(function(e){if(console.debug("removing order "+i+" from view"),o.orders.remove(n),e.NewItem&&o.orders.push(new OrderItemViewModel(e.NewItem)),o.pages().length!==e.NewPageCount){console.debug("page count changed from "+o.pages().length+" to "+e.NewPageCount),o.pages.pop();var t=o.currentPageIndex()+1;t>o.pages().length&&o.loadPage(t-1)}}).fail(function(e){console.error("failed to delete order: "+e.responseText+" ("+e.statusText+")"),console.debug(JSON.stringify(e)),alert("order "+n.name+" could not be removed")})}else console.error("order "+i+" not found")},this.loadPage=function(e){var t=e-1;t!==o.currentPageIndex()&&$.ajax({async:!1,type:"GET",url:"/OrderList/LoadPage",data:{pageIndex:t},dataType:"json"}).done(function(e){console.debug("order list for page index "+t+" successfully retrieved"),o.currentPageIndex(t),o.orders(_.map(e,function(e){return new OrderItemViewModel(e)}))}).fail(function(e){console.error("failed to load page: "+e.responseText+" ("+e.statusText+")"),console.debug(JSON.stringify(e))})}};